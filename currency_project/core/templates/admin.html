<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&family=Fira+Code&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: url('https://images.unsplash.com/photo-1639322537228-f710d846310a?q=80&w=1600&auto=format&fit=crop') no-repeat center center/cover fixed;
            color: white;
            padding: 20px;
        }
        body::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 12, 41, 0.95); z-index: -1;
        }

        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid rgba(0, 255, 200, 0.3); padding-bottom: 15px; }
        .brand { font-family: 'Orbitron', sans-serif; font-size: 24px; color: #00ffc8; text-shadow: 0 0 10px rgba(0, 255, 200, 0.5); }
        .logout-btn { background: rgba(220, 53, 69, 0.2); border: 1px solid #dc3545; color: #ff6b6b; padding: 8px 20px; border-radius: 20px; text-decoration: none; font-size: 14px; transition: 0.3s; }
        .logout-btn:hover { background: #dc3545; color: white; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            transition: 0.3s;
        }
        .panel:hover { border-color: #00ffc8; box-shadow: 0 0 20px rgba(0, 255, 200, 0.1); }

        h2 { font-family: 'Orbitron', sans-serif; font-size: 18px; margin-bottom: 20px; color: #00b4d8; border-left: 4px solid #00b4d8; padding-left: 10px; }

        input, button, select { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 5px; border: none; outline: none; }
        input, select { background: rgba(0, 0, 0, 0.3); color: white; border: 1px solid rgba(255, 255, 255, 0.1); }
        input:focus, select:focus { border-color: #00ffc8; }
        select option { background: #1a1a2e; color: white; }
        input[type="file"] { padding: 10px; background: rgba(0, 255, 200, 0.1); color: #00ffc8; cursor: pointer; }

        .btn-action { font-family: 'Orbitron', sans-serif; font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
        .btn-blue { background: linear-gradient(45deg, #00b4d8, #0077b6); color: white; }
        .btn-green { background: linear-gradient(45deg, #00ffc8, #00b4d8); color: #0f0c29; }
        .btn-action:hover { transform: translateY(-2px); filter: brightness(1.2); }

        .msg { padding: 15px; border-radius: 5px; margin-bottom: 20px; font-size: 14px; border-left: 5px solid; }
        .success { background: rgba(40, 167, 69, 0.2); color: #2ecc71; border-color: #2ecc71; }
        .error { background: rgba(220, 53, 69, 0.2); color: #ff6b6b; border-color: #ff6b6b; }

        .ledger-panel { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-family: 'Fira Code', monospace; font-size: 13px; table-layout: fixed; }
        th { text-align: left; padding: 15px; color: #00b4d8; border-bottom: 2px solid rgba(255, 255, 255, 0.1); }
        td { padding: 12px 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: rgba(255, 255, 255, 0.8); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        tr:hover td { background: rgba(0, 255, 200, 0.05); color: white; }
        .hash { color: #e67e22; }
        .block-id { color: #00ffc8; font-weight: bold; }
        th:nth-child(1) { width: 8%; }
        th:nth-child(2) { width: 10%; }
        th:nth-child(3) { width: 25%; }
        th:nth-child(4) { width: 30%; }
        th:nth-child(5) { width: 20%; }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-card {
            background: #1a1a2e; border: 1px solid #00ffc8;
            width: 350px; padding: 30px; border-radius: 20px;
            text-align: center; box-shadow: 0 0 30px rgba(0, 255, 200, 0.3);
            position: relative;
        }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; color: #ff6b6b; cursor: pointer; }
        .profile-pic-large {
            width: 100px; height: 100px; border-radius: 50%;
            border: 3px solid #00ffc8; object-fit: cover;
            margin-bottom: 15px;
        }
        .user-role {
            background: rgba(0, 255, 200, 0.1); color: #00ffc8;
            padding: 5px 10px; border-radius: 15px; font-size: 12px; margin-bottom: 20px; display: inline-block;
        }
        .info-row {
            display: flex; justify-content: space-between; padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 14px;
        }
        .info-label { color: #aaa; }
        .info-val { font-weight: bold; color: white; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="brand"><i class="fas fa-shield-alt"></i> CURRENCY GUARD <span style="font-size: 12px; color: #aaa;">// ADMIN TERMINAL</span></div>
            <a href="{% url 'logout' %}" class="logout-btn"><i class="fas fa-power-off"></i> LOGOUT</a>
        </div>

        {% if message %}
            <div class="msg {{ msg_type }}">
                {% if msg_type == 'success' %}<i class="fas fa-check-circle"></i>{% else %}<i class="fas fa-exclamation-triangle"></i>{% endif %} 
                {{ message }}
            </div>
        {% endif %}

        <div class="dashboard-grid">

            <div class="panel" style="grid-column: span 2;">
                <h2><i class="fas fa-map-marked-alt"></i> Track Currency History</h2>
                <form method="POST" style="display: flex; gap: 10px;">
                    {% csrf_token %}
                    <input type="text" name="target_serial" placeholder="Enter Serial Number (e.g. 7GA12345)" style="margin-bottom: 0;" required>
                    <button type="submit" name="track_btn" class="btn-action btn-blue" style="width: 150px; margin-bottom: 0;">
                        <i class="fas fa-search"></i> Trace
                    </button>
                </form>

                {% if tracking_logs %}
                <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                    <p style="font-size: 12px; color: #00ffc8; margin-bottom: 10px;">Found {{ tracking_logs.count }} events.</p>
                    <table style="width: 100%; font-size: 11px; color: #aaa;">
                        <tr>
                            <th>TIME</th> <th>SCANNED BY</th> <th>STATUS</th> <th>LOCATION</th>
                        </tr>
                        {% for log in tracking_logs %}
                        <tr>
                            <td>{{ log.timestamp|date:"M d, H:i" }}</td>
                            
                            <td>
                                <span style="color: white; font-weight: bold; cursor: pointer; text-decoration: underline;" 
                                      onclick="showUser('{{ log.scanned_by.username }}', '{{ log.scanned_by.profile.mobile }}', '{{ log.scanned_by.email }}', '{{ log.scanned_by.profile.profile_picture.url }}')">
                                    <i class="fas fa-user-circle"></i> {{ log.scanned_by.username }}
                                </span>
                            </td>

                            <td>{% if "Verified" in log.status %}✔{% else %}✖{% endif %}</td>
                            <td>{{ log.location }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
                {% endif %}
            </div>
            
            <div class="panel">
                <h2><i class="fas fa-university"></i> RBI Authority Terminal</h2>
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 3px solid #f1c40f;">
                        <label style="font-size: 10px; color: #f1c40f; font-weight: bold;">AUTHORITY</label>
                        <select name="issuing_authority" style="margin-bottom: 5px;" required>
                             <option value="RBI">Reserve Bank of India</option>
                             <option value="OTHER">Commercial Bank</option>
                        </select>
                        <input type="text" name="license_id" placeholder="License Key (e.g. RBI-HQ-01)" required>
                    </div>
                    <label style="font-size: 10px; color: #00b4d8; font-weight: bold;">VALUE & IMAGE</label>
                    <div style="display: flex; gap: 10px;">
                        <select name="manual_value" required style="width: 40%;">
                            <option value="500">₹ 500</option>
                            <option value="2000">₹ 2000</option>
                            <option value="200">₹ 200</option>
                            <option value="100">₹ 100</option>
                        </select>
                        <input type="file" name="admin_image" accept="image/*" required>
                    </div>
                    <label style="font-size: 10px; color: #e74c3c; font-weight: bold;">SECURITY KEY (2FA)</label>
                    <input type="password" name="mint_password" placeholder="Enter Password (RBI2025)" required style="border: 1px solid #e74c3c;">
                    <button type="submit" name="mint_btn" class="btn-action btn-green" style="margin-top: 10px;">
                        <i class="fas fa-fingerprint"></i> AUTHORIZE & MINT
                    </button>
                </form>
            </div>

        </div>

        <div class="panel ledger-panel">
            <h2><i class="fas fa-link"></i> Live Blockchain Ledger</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th> <th>VALUE</th> <th>SERIAL</th> <th>HASH</th> <th>ACTION</th>
                    </tr>
                </thead>
                <tbody>
                    {% for block in chain %}
                    <tr>
                        <td class="block-id">#{{ block.index }}</td>
                        <td><span style="color: #00ffc8; border: 1px solid #00ffc8; padding: 2px 5px; border-radius: 3px;">₹{{ block.denomination }}</span></td>
                        <td title="{{ block.serial_no }}">{{ block.serial_no|slice:":15" }}...</td>
                        <td class="hash" title="{{ block.hash }}">{{ block.hash|slice:":10" }}...</td>
                        <td>
                            <a href="{% url 'download_receipt' block.id %}" target="_blank">
                                <button type="button" style="background: #e67e22; border: none; padding: 5px 10px; border-radius: 3px; color: white; cursor: pointer; font-size: 11px; font-weight: bold;">
                                    <i class="fas fa-file-pdf"></i> RECEIPT
                                </button>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" style="text-align:center; padding: 20px;">Blockchain Not Initiated.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="panel" style="margin-top: 20px; border: 1px solid #e67e22;">
            <div style="font-family: 'Fira Code'; font-size: 12px; color: #e67e22;">
                <strong><i class="fas fa-network-wired"></i> ETHEREUM MAINNET:</strong> {{ network_stats.status }} | Block Height: {{ network_stats.block_height }}
            </div>
        </div>
    </div>

    <div id="userModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-card">
            <span class="close-modal" onclick="document.getElementById('userModal').style.display='none'">&times;</span>
            
            <img id="modalImg" src="" class="profile-pic-large">
            
            <h2 id="modalName" style="margin-bottom: 5px;">Username</h2>
            <span class="user-role">REGISTERED USER</span>
            
            <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">

            <div class="info-row">
                <span class="info-label">Mobile</span>
                <span class="info-val" id="modalMobile">+91 ...</span>
            </div>
            <div class="info-row" style="border:none;">
                <span class="info-label">Email</span>
                <span class="info-val" id="modalEmail">user@...</span>
            </div>
        </div>
    </div>

    <script>
        function showUser(name, mobile, email, imgUrl) {
            document.getElementById('modalName').innerText = name;
            document.getElementById('modalMobile').innerText = mobile ? mobile : "N/A";
            document.getElementById('modalEmail').innerText = email ? email : "N/A";
            
            if(imgUrl && imgUrl !== 'None' && imgUrl !== '') {
                document.getElementById('modalImg').src = imgUrl;
            } else {
                document.getElementById('modalImg').src = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            }
            
            document.getElementById('userModal').style.display = 'flex';
        }

        function closeModal(e) {
            if(e.target.className === 'modal-overlay') {
                document.getElementById('userModal').style.display = 'none';
            }
        }
    </script>

</body>
</html>